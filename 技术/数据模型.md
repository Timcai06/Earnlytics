# 数据模型

> 数据库表结构、关系图与扩展指南

---

## 实体关系

```
companies ──1:N──► earnings ──1:1──► ai_analyses

subscribers（独立表）

error_logs / operation_logs（审计表）
```

## 表结构

### companies（公司表）
```sql
CREATE TABLE companies (
  id SERIAL PRIMARY KEY,
  symbol VARCHAR(10) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  sector VARCHAR(50),
  market_cap BIGINT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### earnings（财报表）
```sql
CREATE TABLE earnings (
  id SERIAL PRIMARY KEY,
  company_id INTEGER REFERENCES companies(id),
  fiscal_year INTEGER NOT NULL,
  fiscal_quarter INTEGER NOT NULL,
  report_date DATE NOT NULL,
  revenue NUMERIC(20, 2),
  revenue_yoy_growth DECIMAL(5, 2),
  eps DECIMAL(10, 2),
  eps_estimate DECIMAL(10, 2),
  net_income NUMERIC(20, 2),
  is_analyzed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(company_id, fiscal_year, fiscal_quarter)
);
```

### ai_analyses（AI分析表）
```sql
CREATE TABLE ai_analyses (
  id SERIAL PRIMARY KEY,
  earnings_id INTEGER REFERENCES earnings(id) UNIQUE,
  summary TEXT NOT NULL,
  highlights JSONB,
  concerns JSONB,
  sentiment VARCHAR(20),
  cost_usd DECIMAL(10, 6),
  created_at TIMESTAMP DEFAULT NOW()
);
```

### subscribers（订阅表）
```sql
CREATE TABLE subscribers (
  id SERIAL PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  is_active BOOLEAN DEFAULT TRUE,
  subscribed_at TIMESTAMP DEFAULT NOW()
);
```

## 索引设计

```sql
-- 常用查询索引
CREATE INDEX idx_earnings_company ON earnings(company_id);
CREATE INDEX idx_earnings_date ON earnings(report_date DESC);
CREATE INDEX idx_earnings_unanalyzed ON earnings(is_analyzed) WHERE is_analyzed = FALSE;
CREATE INDEX idx_subscribers_active ON subscribers(is_active) WHERE is_active = TRUE;
```

## 扩展指南

### 添加新字段
```sql
-- 方法1：添加列
ALTER TABLE earnings ADD COLUMN rd_expense NUMERIC(20, 2);

-- 方法2：使用JSONB
UPDATE earnings SET raw_data = raw_data || '{"new_field": "value"}'::jsonb;
```

### 添加新表
```sql
-- 股价历史表
CREATE TABLE stock_prices (
  id SERIAL PRIMARY KEY,
  company_id INTEGER REFERENCES companies(id),
  date DATE NOT NULL,
  close_price DECIMAL(10, 2),
  UNIQUE(company_id, date)
);
```

---

详细API集成见：API文档.md
