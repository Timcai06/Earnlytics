# 应用流程规范

**更新日期:** 2026-02-18  
**版本:** 1.1

---

## 概述

本文档描述 Earnlytics 应用的核心业务流程、用户旅程和系统交互。

---

## 用户角色

| 角色 | 描述 | 权限 |
|------|------|------|
| 访客 | 未登录用户 | 浏览公开财报、订阅邮件 |
| 注册用户 | 已登录用户 | 个人仪表盘、预警设置、AI助手 |
| 管理员 | 系统管理员 | 数据管理、系统配置 |

---

## 核心业务流程

### 1. 财报数据获取流程

**流程步骤:**
1. GitHub Actions 每4小时触发
2. 执行 `fetch-earnings.ts` 脚本
3. 调用 FMP API 获取最新财报数据
4. 写入 Supabase `earnings` 表
5. 标记 `is_analyzed=false`
6. 触发 `analyze-batch` 进行 AI 分析
7. 调用 DeepSeek API 生成中文分析
8. 写入 `ai_analyses` 表
9. 标记 `is_analyzed=true`

### 2. 用户浏览财报流程

**流程步骤:**
1. 用户访问首页，加载 HeroSearch
2. 输入股票代码或搜索公司
3. 跳转至 `/earnings/[symbol]`
4. 页面并行获取数据:
   - 公司基本信息 (`companies`)
   - 财报数据 (`earnings`)
   - AI 分析结果 (`ai_analyses`)
   - 估值数据 (`company_valuation`)

### 3. 用户认证流程

**流程步骤:**
1. 点击登录，跳转 `/login`
2. 输入邮箱密码
3. POST `/api/auth/login`
4. 验证 credentials
5. 生成 session
6. 存储用户信息到 localStorage
7. 更新 Header 显示用户信息
8. 跳转首页或原页面

**安全要点:**
- 密码使用 bcrypt 哈希存储
- JWT Token 用于身份验证

### 4. 邮件订阅流程

**流程步骤:**
1. 首页输入邮箱
2. POST `/api/subscribe`
3. 验证邮箱格式
4. 写入 `subscribers` 表
5. 发送欢迎邮件
6. 显示成功提示

### 5. 投资分析流程

**流程步骤:**
1. 用户访问 `/analysis/[symbol]` 页面
2. 并行获取多维度数据:
   - 公司基本信息 (`companies`)
   - 估值数据 (`company_valuation`)
   - 同行对比数据 (`peer_comparison`)
   - 行业基准数据 (`industry_benchmarks`)
3. 计算估值百分位、同行排名
4. 生成投资评级和建议
5. 渲染图表和指标卡片

**分析维度:**
- **估值分析**: PE、PB、PS 历史百分位
- **财务健康度**: ROE、ROA、负债率
- **同行对比**: 行业排名、相对强弱
- **增长分析**: 收入增长率、利润率趋势

### 6. 预警系统流程

**预警类型:**
- 评级变化提醒
- 目标价大幅调整
- 估值异常提醒
- 财报发布提醒
- 价格阈值提醒

**流程步骤:**
1. 用户设置预警规则，写入 `alert_rules` 表
2. GitHub Actions 定时检查
3. 执行 `process-alerts.ts`
4. 扫描触发条件
5. 条件满足时创建 `alert_history` 记录
6. 发送邮件通知
7. 更新 `trigger_count`

---

## 页面流程图

### 首页 (Home)

```
┌─────────────────────────────────────────────────┐
│  Header (Logo + Search + Login + Menu)          │
├─────────────────────────────────────────────────┤
│  Hero Section                                    │
│  - 标题: AI财报分析 | 1小时获取洞察             │
│  - 副标题 + 搜索框                              │
│  - CTA 按钮                                     │
│                                                  │
│  Stats Bar (公司数 | 财报数 | 分析数 | 订阅数)  │
│  Market Ticker (实时行情)                        │
│  Earnings Calendar (财报日历)                    │
│  Features Section (功能特性)                     │
│  FAQ Section (常见问题)                          │
│  Subscribe Section (邮件订阅)                    │
│  Footer                                          │
└─────────────────────────────────────────────────┘
```

### 财报详情页

```
┌─────────────────────────────────────────────────┐
│  Header                                          │
├─────────────────────────────────────────────────┤
│  Breadcrumb: 首页 > AAPL > Q4 2025               │
│  公司信息 Card                                   │
│  - Logo + 名称 + 股票代码                        │
│  - 行业标签                                      │
│  - 实时股价                                      │
│  关键指标 Grid                                   │
│  AI 分析 Card                                    │
│  - 情绪标签 (积极/中性/消极)                     │
│  - 分析摘要                                      │
│  - 亮点列表                                      │
│  - 关注点                                        │
│  估值指标 Card                                   │
│  历史财报 Table                                  │
│  相关研报列表                                    │
└─────────────────────────────────────────────────┘
```

### 投资分析页

```
┌─────────────────────────────────────────────────┐
│  Header                                          │
├─────────────────────────────────────────────────┤
│  Breadcrumb: 首页 > AAPL > 投资分析              │
│  公司概览 Card                                   │
│  - Logo + 名称 + 股票代码                        │
│  - 当前评级 (买入/持有/卖出)                     │
│  - 目标价区间                                    │
│  估值分析 Section                                │
│  - PE/PB/PS 历史百分位图表                       │
│  - 行业对比图表                                  │
│  财务健康度 Card                                 │
│  - ROE、ROA、ROIC 指标                           │
│  - 负债率、流动比率                              │
│  同行对比 Section                                │
│  - 可比公司列表                                  │
│  - 相对排名 (PE、ROE 等)                         │
│  投资要点 Summary                                │
│  - 优势                                          │
│  - 风险                                          │
│  - 建议                                          │
└─────────────────────────────────────────────────┘
```

### 公司列表页

```
┌─────────────────────────────────────────────────┐
│  Header                                          │
├─────────────────────────────────────────────────┤
│  Breadcrumb: 首页 > 公司列表                     │
│  筛选器 Bar                                      │
│  - 行业下拉选择                                  │
│  - 搜索框                                        │
│  - 排序选项                                      │
│  公司卡片 Grid                                   │
│  - Logo + 名称 + 代码                            │
│  - 行业标签                                      │
│  - 关键指标 (市值、PE)                           │
│  - 最新财报日期                                  │
│  Pagination                                      │
└─────────────────────────────────────────────────┘
```

---

## 数据流转

### 财报数据流

```
FMP API (数据源)
    ↓
earnings (原始数据)
    ↓
ai_analyses (AI分析)
    ↓
前端展示 (React)
```

### 用户数据流

```
用户操作 (Frontend)
    ↓
API Route (Next.js)
    ↓
Supabase (Database)
    ↓
AI服务 (DeepSeek)
```

---

## 性能优化流程

### 页面加载优化

1. Server Component 获取初始数据
2. 流式传输 HTML (Streaming SSR)
3. Hydration 完成前显示 Skeleton
4. 交互组件逐步激活

### 数据缓存策略

```typescript
// Next.js 缓存配置
export const revalidate = 3600; // 1小时 ISR
```

---

**相关文档:**
- [后端架构](./BACKEND_STRUCTURE.md)
- [前端规范](./FRONTED_GUIDELINES.md)
- [实施指南](./IMPLEMENTATION.md)

---

## 附录 A: 详细流程规范

### A.1 用户注册流程 (详细)

```
触发条件: 用户点击注册按钮

流程步骤:
1. 用户访问 /signup 页面
   └── 成功: 显示注册表单
   └── 失败: 显示错误页面 (500)

2. 用户填写表单 (邮箱、密码、确认密码)
   ├── 前端验证:
   │   ├── 邮箱格式验证
   │   ├── 密码长度 >= 8
   │   └── 密码和确认密码匹配
   └── 验证失败: 显示字段级错误提示

3. 用户提交表单
   ├── 显示加载状态
   ├── POST /api/auth/signup
   │   ├── 验证输入 (Zod)
   │   ├── 检查邮箱是否已存在
   │   ├── 密码哈希 (bcrypt)
   │   └── 创建用户记录
   └── 响应处理:
       ├── 成功 (201): 跳转到登录页，显示成功消息
       ├── 邮箱已存在 (409): 显示错误 "该邮箱已注册"
       └── 服务器错误 (500): 显示 "注册失败，请重试"

决策点:
- 邮箱已注册? → 提示登录而不是注册
- 密码强度不足? → 显示密码强度要求
- 网络错误? → 允许重试
```

### A.2 财报数据获取流程 (自动化)

```
触发条件: GitHub Actions 定时触发 (每4小时)

流程步骤:
1. GitHub Actions 启动 workflow
   └── 环境: ubuntu-latest
   └── Node.js: 20.x

2. 执行 fetch-earnings.ts 脚本
   ├── 加载环境变量 (.env.local)
   ├── 连接 Supabase
   └── 查询需要更新的公司列表

3. 调用 FMP API
   ├── 构建请求 URL
   ├── 添加 API Key
   └── 设置超时 (30s)
   └── 错误处理:
       ├── API 限流 (429): 等待 60s 重试
       ├── 网络错误: 重试 3 次
       └── 数据格式错误: 记录日志，跳过

4. 解析和清洗数据
   ├── 验证数据完整性
   ├── 转换日期格式
   └── 标准化数值

5. 写入 Supabase
   ├── 开始事务
   ├── 插入/更新 earnings 表
   ├── 标记 is_analyzed = false
   └── 提交事务
   └── 错误处理:
       └── 写入失败: 回滚事务，记录错误

6. 触发 AI 分析
   ├── 查询未分析的财报
   ├── 调用 analyze-batch.ts
   └── 批量处理 (每次5条)

7. 发送通知 (可选)
   └── 有新财报时通知订阅者

决策点:
- 数据已存在? → 更新而不是插入
- API 无新数据? → 正常结束
- 处理失败? → 记录到 error log，继续处理其他
```

### A.3 财报详情页加载流程

```
触发条件: 用户访问 /earnings/[symbol]

流程步骤:
1. 路由匹配
   └── 提取 symbol 参数
   └── 验证 symbol 格式 (字母，2-5字符)
   └── 无效: 404 页面

2. 服务端数据获取 (并行)
   ├── Promise.all([
   │   getCompany(symbol),       // 公司信息
   │   getLatestEarnings(symbol),// 最新财报
   │   getAIAnalysis(symbol),    // AI分析
   │   getValuation(symbol),     // 估值数据
   │   getStockPrice(symbol)     // 实时股价
   │ ])
   └── 错误处理:
       ├── 公司不存在: 404 页面
       ├── 财报不存在: 显示 "暂无数据"
       └── 单个接口失败: 使用备用数据或隐藏该部分

3. 渲染页面 (流式传输)
   ├── 立即渲染: Header, Footer, 公司信息骨架屏
   ├── 流式渲染: 财务指标、AI分析
   └── 客户端渲染: 实时股价 (每 30s 刷新)

4. 客户端 Hydration
   ├── 激活交互组件
   ├── 绑定事件处理器
   └── 开始数据轮询 (股价)

决策点:
- 用户未登录? → 显示登录提示 (可选)
- 数据加载慢? → 显示 Skeleton 加载态
- 部分数据缺失? → 优雅降级显示
```

---

## 附录 B: 错误状态处理规范

### B.1 全局错误码

| 错误码 | 场景 | 用户提示 | 处理建议 |
|--------|------|----------|----------|
| 400 | 请求参数错误 | "请求参数不正确，请检查输入" | 检查表单输入 |
| 401 | 未登录 | "请先登录" | 跳转到登录页 |
| 403 | 无权限 | "您没有权限访问此内容" | 显示权限不足页面 |
| 404 | 资源不存在 | "页面或内容不存在" | 显示 404 页面 |
| 429 | 请求过于频繁 | "操作太频繁，请稍后再试" | 降低操作频率 |
| 500 | 服务器错误 | "服务器繁忙，请稍后重试" | 稍后重试 |
| 502/503 | 服务不可用 | "服务暂时不可用" | 显示维护页面 |

### B.2 错误处理模式

**前端错误处理:**
```typescript
// API 请求封装
try {
  const data = await fetchAPI('/api/earnings/AAPL')
} catch (error) {
  if (error.status === 404) {
    // 显示 "暂无数据" 提示
  } else if (error.status === 500) {
    // 显示错误提示，提供重试按钮
  } else {
    // 通用错误提示
  }
}
```

**空状态处理:**
```typescript
// 数据为空时显示 EmptyState 组件
{!data || data.length === 0 ? (
  <EmptyState 
    title="暂无数据"
    description="该公司暂时还没有财报数据"
    action={{
      label: "查看其他公司",
      onClick: () => router.push('/companies')
    }}
  />
) : (
  <DataList data={data} />
)}
```

**加载状态处理:**
```typescript
// 使用 Skeleton 组件
{isLoading ? (
  <div className="space-y-4">
    <Skeleton className="h-8 w-3/4" />
    <Skeleton className="h-32 w-full" />
    <Skeleton className="h-32 w-full" />
  </div>
) : (
  <ActualContent data={data} />
)}
```

---

## 附录 C: 决策点矩阵

| 决策场景 | 条件 | 分支 A | 分支 B | 分支 C |
|---------|------|--------|--------|--------|
| 用户访问财报页 | 是否已登录? | 显示完整内容 | 显示登录提示 | - |
| 财报数据获取 | 是否已分析? | 直接显示 | 触发AI分析 | - |
| AI分析失败 | 失败原因? | 重试 | 使用缓存 | 显示人工分析 |
| 用户订阅 | 邮箱是否有效? | 发送确认邮件 | 显示格式错误 | - |
| 预警触发 | 严重程度? | 立即邮件 | 每日摘要 | 不通知 |

---

**文档结束**
