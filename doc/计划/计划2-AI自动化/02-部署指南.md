# Plan 2 部署指南

## 部署前准备

### 1. Supabase数据库设置

1. 登录 Supabase 控制台: https://supabase.com/dashboard
2. 进入项目: `sdbdvtnhidifpdtyziwu`
3. 打开 SQL Editor
4. 执行以下 SQL 脚本创建表:

```sql
-- 复制 001_initial_schema.sql 的全部内容并执行
-- 文件位置: earnlytics-web/supabase/migrations/001_initial_schema.sql
```

### 2. GitHub Secrets 配置

在 GitHub 仓库设置中添加以下 Secrets:

| Secret Name | Value |
|-------------|-------|
| `DEEPSEEK_API_KEY` | sk-eb9bd37f772141e2a55a5ace60a4ce66 |
| `DEEPSEEK_API_URL` | https://api.deepseek.com/v1/chat/completions |
| `FMP_API_KEY` | KAsCR02pUvLLqfyLnt1llUq5vuq8vUuG |
| `NEXT_PUBLIC_SUPABASE_URL` | https://sdbdvtnhidifpdtyziwu.supabase.co |
| `SUPABASE_SERVICE_ROLE_KEY` | (从 Supabase Dashboard > Project Settings > API 获取 service_role key) |
| `VERCEL_DEPLOY_HOOK` | (从 Vercel Dashboard > Project Settings > Git > Deploy Hooks 获取) |

### 3. Vercel 环境变量配置

在 Vercel Dashboard 中设置以下环境变量:

```
NEXT_PUBLIC_SUPABASE_URL=https://sdbdvtnhidifpdtyziwu.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkYmR2dG5oaWRpZnBkdHl6aXd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NTMyNjksImV4cCI6MjA4NjAyOTI2OX0.qqwH4ObruEroG6NOIVk1b_yC_wpsaDGMl21We5dHT0M
DEEPSEEK_API_KEY=sk-eb9bd37f772141e2a55a5ace60a4ce66
FMP_API_KEY=KAsCR02pUvLLqfyLnt1llUq5vuq8vUuG
```

## 首次数据填充

### 本地执行（推荐）

```bash
cd earnlytics-web

# 1. 创建本地环境变量文件
cp .env.example .env.local

# 2. 编辑 .env.local 填入所有密钥

# 3. 获取财报数据
npm run fetch:earnings

# 4. 运行AI分析（每次最多5条）
npm run analyze:batch
```

### 手动触发 GitHub Actions

1. 进入 GitHub 仓库
2. 点击 Actions 标签
3. 选择 "Update Earnings Data" 工作流
4. 点击 "Run workflow"

## 自动化流程

GitHub Actions 会每4小时自动执行:
1. 从 FMP API 获取最新财报数据
2. 对未分析的财报运行 DeepSeek AI 分析
3. 触发 Vercel 重新部署

## 成本估算

| 项目 | 数量/月 | 单价 | 月成本 |
|------|---------|------|--------|
| DeepSeek API | ~50次分析 | ¥0.002/千tokens | ~¥0.2 |
| FMP API | 免费额度 | 免费 | ¥0 |
| Supabase | 免费额度 | 免费 | ¥0 |
| **总计** | | | **~¥0.2** |

## 监控与调试

### 查看 GitHub Actions 运行状态
- 仓库页面 > Actions 标签
- 查看每次运行的日志

### 查看 Vercel 部署状态
- Vercel Dashboard > Deployments
- 查看每次部署的详情

### Supabase 数据检查
```sql
-- 检查公司数量
SELECT COUNT(*) FROM companies;

-- 检查财报数量
SELECT COUNT(*) FROM earnings;

-- 检查AI分析数量
SELECT COUNT(*) FROM ai_analyses;

-- 查看待分析的财报
SELECT e.*, c.symbol, c.name 
FROM earnings e 
JOIN companies c ON e.company_id = c.id 
WHERE e.is_analyzed = false;
```

## 故障排除

### 1. GitHub Actions 失败
- 检查 Secrets 是否正确配置
- 查看 Actions 日志中的错误信息

### 2. API 返回 500
- 检查 Vercel 环境变量
- 查看 Vercel Functions 日志

### 3. AI 分析失败
- 检查 DeepSeek API 余额
- 检查 API Key 是否有效

### 4. 数据未更新
- 检查 FMP API 调用限制
- 手动运行 `npm run fetch:earnings` 测试

## 后续步骤

1. ✅ 完成 Plan 2 开发
2. ⏳ 执行数据库迁移
3. ⏳ 配置 GitHub Secrets
4. ⏳ 配置 Vercel 环境变量
5. ⏳ 首次数据填充
6. ⏳ 验证自动化流程
7. ⏳ 进入 Plan 3: 规模化
