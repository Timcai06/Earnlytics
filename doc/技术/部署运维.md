# 部署运维

> 生产环境部署、监控、备份与故障处理

---

## 部署流程

```
代码提交 → GitHub → Vercel自动构建 → 全球部署
```

## Vercel配置

### 环境变量
```
FMP_API_KEY=
DEEPSEEK_API_KEY=
SUPABASE_URL=
SUPABASE_ANON_KEY=
```

### vercel.json
```json
{
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        { "key": "X-Content-Type-Options", "value": "nosniff" },
        { "key": "X-Frame-Options", "value": "DENY" }
      ]
    }
  ]
}
```

## GitHub Actions

### 每日更新
```yaml
name: Daily Update
on:
  schedule:
    - cron: '0 */4 * * *'  # 每4小时

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npx tsx scripts/fetch-earnings.ts
        env:
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
      - run: npx tsx scripts/analyze-batch.ts
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      - run: curl -X POST ${{ secrets.VERCEL_DEPLOY_HOOK }}
```

## 监控

### 健康检查API
```typescript
// app/api/health/route.ts
export async function GET() {
  const checks = {
    database: await checkDatabase(),
    fmp_api: await checkFMPAPI()
  }
  
  const isHealthy = Object.values(checks).every(Boolean)
  
  return NextResponse.json(
    { status: isHealthy ? 'healthy' : 'unhealthy', checks },
    { status: isHealthy ? 200 : 503 }
  )
}
```

### 工具
- Vercel Analytics（免费）
- Google Analytics（免费）
- UptimeRobot（免费）

## 备份

### 自动备份
- Supabase每日自动备份
- 保留7天

### 手动导出
```bash
supabase db dump -f backup.sql
```

## 故障处理

### 网站无法访问
1. 检查Vercel部署日志
2. 检查环境变量
3. 回滚到上一版本

### 数据未更新
1. 检查GitHub Actions运行状态
2. 检查API密钥有效性
3. 手动触发更新

### AI分析失败
1. 检查DeepSeek余额
2. 查看错误日志
3. 使用降级方案

---

详细架构见：架构设计.md、数据模型.md
