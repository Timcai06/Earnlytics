# 技术架构文档

> Earnlytics 技术栈与架构设计  
> 版本: 1.0  
> 更新: 2025-02-07

---

## 技术栈概览

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层                                │
│  Next.js 14 + React 18 + TypeScript                         │
│  Tailwind CSS + shadcn/ui                                   │
│  Lucide Icons                                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     API / 服务层                            │
│  Vercel Serverless Functions                                │
│  Supabase Client                                            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     数据层                                  │
│  Supabase PostgreSQL                                        │
│  Supabase Auth                                              │
│  Supabase Storage (可选)                                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   外部服务                                  │
│  FMP API (财报数据)                                         │
│  DeepSeek API (AI分析)                                      │
│  Google AdSense (变现)                                      │
│  Resend (邮件)                                              │
│  Stripe (支付)                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 前端架构

### 技术选型

| 技术 | 用途 | 版本 |
|------|------|------|
| Next.js | React框架 (App Router) | 14.x |
| React | UI库 | 18.x |
| TypeScript | 类型系统 | 5.x |
| Tailwind CSS | 原子化CSS | 3.x |
| shadcn/ui | 组件库 | latest |
| Lucide React | 图标库 | latest |

### 项目结构

```
my-app/
├── app/                          # Next.js App Router
│   ├── (marketing)/              # 营销页面组
│   │   ├── page.tsx              # Landing Page
│   │   └── layout.tsx
│   ├── (auth)/                   # 认证页面组
│   │   ├── login/page.tsx
│   │   ├── signup/page.tsx
│   │   └── layout.tsx
│   ├── (dashboard)/              # 用户功能区
│   │   ├── home/page.tsx
│   │   ├── calendar/page.tsx
│   │   ├── companies/page.tsx
│   │   ├── earnings/[id]/page.tsx
│   │   ├── profile/page.tsx
│   │   └── layout.tsx
│   ├── api/                      # API路由
│   │   └── ...
│   ├── about/page.tsx
│   ├── not-found.tsx
│   ├── layout.tsx                # 根布局
│   └── globals.css
├── components/
│   ├── ui/                       # shadcn/ui 组件
│   ├── layout/                   # 布局组件
│   │   ├── Header.tsx
│   │   ├── Footer.tsx
│   │   └── Sidebar.tsx
│   ├── features/                 # 功能组件
│   │   ├── EarningsCard.tsx
│   │   ├── CompanyCard.tsx
│   │   ├── CalendarGrid.tsx
│   │   └── AIAnalysis.tsx
│   └── charts/                   # 图表组件
├── lib/
│   ├── utils.ts                  # 工具函数
│   ├── supabase.ts               # Supabase客户端
│   ├── ai.ts                     # AI分析模块
│   └── constants.ts              # 常量
├── hooks/
│   └── useAuth.ts
├── types/
│   └── index.ts                  # TypeScript类型
├── public/
│   └── ...                       # 静态资源
├── styles/
│   └── design-tokens.css         # Design Token
├── scripts/                      # 自动化脚本
│   ├── fetch-earnings.ts
│   └── analyze-batch.ts
├── .env.local                    # 环境变量
├── tailwind.config.ts
└── next.config.js
```

### Design Token 代码化

```typescript
// tailwind.config.ts
import type { Config } from "tailwindcss"

const config: Config = {
  darkMode: ["class"],
  content: [
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./app/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      // 颜色系统
      colors: {
        primary: {
          DEFAULT: "#2563EB",
          hover: "#1D4ED8",
          light: "#EFF6FF",
          foreground: "#FFFFFF",
        },
        background: "#FAFAFA",
        surface: "#FFFFFF",
        foreground: "#0F172A",
        muted: {
          DEFAULT: "#F1F5F9",
          foreground: "#64748B",
        },
        border: "#E2E8F0",
        success: {
          DEFAULT: "#16A34A",
          light: "#DCFCE7",
          foreground: "#FFFFFF",
        },
        warning: {
          DEFAULT: "#991B1B",
          light: "#FEF2F2",
          foreground: "#FFFFFF",
        },
        info: {
          DEFAULT: "#1E40AF",
          light: "#F5F3FF",
          foreground: "#FFFFFF",
        },
        // shadcn 兼容
        card: {
          DEFAULT: "hsl(var(--card))",
          foreground: "hsl(var(--card-foreground))",
        },
        popover: {
          DEFAULT: "hsl(var(--popover))",
          foreground: "hsl(var(--popover-foreground))",
        },
        secondary: {
          DEFAULT: "hsl(var(--secondary))",
          foreground: "hsl(var(--secondary-foreground))",
        },
        accent: {
          DEFAULT: "hsl(var(--accent))",
          foreground: "hsl(var(--accent-foreground))",
        },
        destructive: {
          DEFAULT: "hsl(var(--destructive))",
          foreground: "hsl(var(--destructive-foreground))",
        },
        input: "hsl(var(--input))",
        ring: "hsl(var(--ring))",
      },
      // 间距系统
      spacing: {
        '18': '4.5rem',    // 72px
        '22': '5.5rem',    // 88px
      },
      // 圆角系统
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
        xl: "16px",
        "2xl": "24px",
      },
      // 字体系统
      fontFamily: {
        sans: ["Inter", "system-ui", "sans-serif"],
      },
      fontSize: {
        'display': ['4rem', { lineHeight: '1.1', fontWeight: '700' }],
        'h1': ['3rem', { lineHeight: '1.2', fontWeight: '700' }],
        'h2': ['2.5rem', { lineHeight: '1.2', fontWeight: '700' }],
        'h3': ['2rem', { lineHeight: '1.3', fontWeight: '600' }],
        'h4': ['1.5rem', { lineHeight: '1.4', fontWeight: '600' }],
        'h5': ['1.25rem', { lineHeight: '1.4', fontWeight: '600' }],
        'body': ['1rem', { lineHeight: '1.5' }],
        'body-sm': ['0.875rem', { lineHeight: '1.5' }],
        'caption': ['0.75rem', { lineHeight: '1.5' }],
      },
      // 阴影
      boxShadow: {
        'card': '0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1)',
        'card-hover': '0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)',
      },
    },
  },
  plugins: [require("tailwindcss-animate")],
}

export default config
```

---

## 数据库架构

### ER 图

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│  companies  │       │  earnings   │       │ ai_analyses │
├─────────────┤       ├─────────────┤       ├─────────────┤
│ id (PK)     │◄──────│ company_id  │◄──────│ earnings_id │
│ symbol (UQ) │       │ fiscal_year │       │ summary     │
│ name        │       │ fiscal_q    │       │ highlights  │
│ sector      │       │ report_date │       │ concerns    │
│ logo_url    │       │ revenue     │       │ sentiment   │
│ created_at  │       │ eps         │       │ tokens_used │
└─────────────┘       │ eps_estimate│       │ cost_usd    │
                      │ net_income  │       │ created_at  │
                      │ is_analyzed │       └─────────────┘
                      │ created_at  │
                      └─────────────┘
                            │
                            │
                      ┌─────────────┐
                      │subscribers  │
                      ├─────────────┤
                      │ id (PK)     │
                      │ email (UQ)  │
                      │ is_active   │
                      │ created_at  │
                      └─────────────┘
```

### Schema 定义

```sql
-- 公司表
CREATE TABLE companies (
  id SERIAL PRIMARY KEY,
  symbol VARCHAR(10) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  name_zh VARCHAR(100),              -- 中文名
  sector VARCHAR(50),
  industry VARCHAR(50),              -- 细分行业
  market_cap BIGINT,                 -- 市值
  logo_url VARCHAR(255),
  website VARCHAR(255),
  description TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 财报表
CREATE TABLE earnings (
  id SERIAL PRIMARY KEY,
  company_id INTEGER REFERENCES companies(id) ON DELETE CASCADE,
  fiscal_year INTEGER NOT NULL,
  fiscal_quarter INTEGER NOT NULL CHECK (fiscal_quarter BETWEEN 1 AND 4),
  report_date DATE NOT NULL,
  report_time VARCHAR(10),           -- 'before' / 'after' market
  
  -- 收入数据
  revenue NUMERIC(20, 2),
  revenue_yoy_growth DECIMAL(5, 2),  -- 同比增长率 %
  revenue_qoq_growth DECIMAL(5, 2),  -- 环比增长率 %
  
  -- EPS 数据
  eps DECIMAL(10, 2),
  eps_estimate DECIMAL(10, 2),
  eps_surprise DECIMAL(10, 2),       -- EPS 超预期幅度
  eps_surprise_pct DECIMAL(5, 2),    -- EPS 超预期百分比
  
  -- 利润数据
  net_income NUMERIC(20, 2),
  net_income_yoy_growth DECIMAL(5, 2),
  operating_income NUMERIC(20, 2),
  gross_profit NUMERIC(20, 2),
  gross_margin DECIMAL(5, 2),
  operating_margin DECIMAL(5, 2),
  net_margin DECIMAL(5, 2),
  
  -- 状态
  is_analyzed BOOLEAN DEFAULT FALSE,
  is_published BOOLEAN DEFAULT FALSE,
  published_at TIMESTAMP,
  
  -- 元数据
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(company_id, fiscal_year, fiscal_quarter)
);

-- AI 分析表
CREATE TABLE ai_analyses (
  id SERIAL PRIMARY KEY,
  earnings_id INTEGER REFERENCES earnings(id) ON DELETE CASCADE UNIQUE,
  
  -- 分析内容
  summary TEXT NOT NULL,             -- 核心摘要
  highlights JSONB,                  -- 亮点列表
  concerns JSONB,                    -- 关注点列表
  sentiment VARCHAR(20),             -- positive/neutral/negative
  sentiment_score DECIMAL(3, 2),     -- -1.0 到 1.0
  
  -- 技术分析
  technical_analysis TEXT,           -- 技术面分析
  valuation_analysis TEXT,           -- 估值分析
  guidance_analysis TEXT,            -- 业绩指引分析
  
  -- 成本追踪
  model VARCHAR(50),                 -- 使用的AI模型
  tokens_used INTEGER,
  prompt_tokens INTEGER,
  completion_tokens INTEGER,
  cost_usd DECIMAL(10, 6),
  
  -- 反馈
  helpful_count INTEGER DEFAULT 0,
  not_helpful_count INTEGER DEFAULT 0,
  
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 财报日历表
CREATE TABLE earnings_calendar (
  id SERIAL PRIMARY KEY,
  company_id INTEGER REFERENCES companies(id),
  report_date DATE NOT NULL,
  report_time VARCHAR(10),           -- 'before' / 'after'
  eps_estimate DECIMAL(10, 2),
  revenue_estimate NUMERIC(20, 2),
  is_confirmed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW()
);

-- 邮件订阅表
CREATE TABLE subscribers (
  id SERIAL PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  is_active BOOLEAN DEFAULT TRUE,
  confirmation_token VARCHAR(255),
  confirmed_at TIMESTAMP,
  preferences JSONB DEFAULT '{}',    -- 订阅偏好
  subscribed_at TIMESTAMP DEFAULT NOW(),
  unsubscribed_at TIMESTAMP
);

-- 订阅偏好表 (用户认证后)
CREATE TABLE user_preferences (
  id SERIAL PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  watchlist INTEGER[] DEFAULT '{}',  -- 关注的公司ID列表
  email_notifications BOOLEAN DEFAULT TRUE,
  notification_frequency VARCHAR(20) DEFAULT 'daily', -- daily/weekly
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id)
);

-- 创建更新时间触发器
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ language 'plpgsql';

-- 应用触发器
CREATE TRIGGER update_companies_updated_at BEFORE UPDATE ON companies
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_earnings_updated_at BEFORE UPDATE ON earnings
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_ai_analyses_updated_at BEFORE UPDATE ON ai_analyses
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- 创建索引
CREATE INDEX idx_earnings_company ON earnings(company_id);
CREATE INDEX idx_earnings_report_date ON earnings(report_date);
CREATE INDEX idx_earnings_is_analyzed ON earnings(is_analyzed);
CREATE INDEX idx_earnings_is_published ON earnings(is_published);
CREATE INDEX idx_calendar_report_date ON earnings_calendar(report_date);
CREATE INDEX idx_subscribers_email ON subscribers(email);
CREATE INDEX idx_subscribers_active ON subscribers(is_active);
```

---

## API 设计

### RESTful API 规范

```typescript
// API 路由结构

// 1. 公司相关
GET    /api/companies              # 获取公司列表
GET    /api/companies/:symbol      # 获取公司详情
GET    /api/companies/:symbol/earnings  # 获取公司财报历史

// 2. 财报相关
GET    /api/earnings               # 获取财报列表 (支持筛选)
GET    /api/earnings/:id           # 获取财报详情
GET    /api/earnings/:id/analysis  # 获取AI分析

// 3. 日历相关
GET    /api/calendar               # 获取财报日历
GET    /api/calendar/upcoming      # 获取即将发布的财报

// 4. 订阅相关
POST   /api/subscribe              # 邮件订阅
DELETE /api/subscribe              # 取消订阅

// 5. 用户相关 (需要认证)
GET    /api/user/profile           # 获取用户信息
PUT    /api/user/profile           # 更新用户信息
GET    /api/user/watchlist         # 获取关注列表
POST   /api/user/watchlist         # 添加关注
DELETE /api/user/watchlist/:id     # 取消关注
```

### API 响应格式

```typescript
// 成功响应
interface ApiResponse<T> {
  success: true;
  data: T;
  meta?: {
    page: number;
    perPage: number;
    total: number;
    totalPages: number;
  };
}

// 错误响应
interface ApiError {
  success: false;
  error: {
    code: string;
    message: string;
    details?: Record<string, string[]>;
  };
}

// 示例: 获取财报列表
// GET /api/earnings?page=1&perPage=10&company=AAPL

{
  "success": true,
  "data": [
    {
      "id": 1,
      "company": {
        "symbol": "AAPL",
        "name": "Apple Inc."
      },
      "fiscalYear": 2026,
      "fiscalQuarter": 1,
      "reportDate": "2026-01-30",
      "revenue": 119575000000,
      "eps": 2.50,
      "isAnalyzed": true
    }
  ],
  "meta": {
    "page": 1,
    "perPage": 10,
    "total": 120,
    "totalPages": 12
  }
}
```

---

## 自动化流水线

### GitHub Actions 工作流

```yaml
# .github/workflows/update.yml
name: Update Earnings Data

on:
  schedule:
    - cron: '0 */4 * * *'  # 每4小时运行
  workflow_dispatch:       # 支持手动触发

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Fetch new earnings
        run: npx tsx scripts/fetch-earnings.ts
        env:
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      
      - name: Analyze with AI
        run: npx tsx scripts/analyze-batch.ts
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      
      - name: Trigger Vercel redeploy
        run: |
          curl -X POST "https://api.vercel.com/v1/integrations/deploy/${{ secrets.VERCEL_PROJECT_ID }}/${{ secrets.VERCEL_DEPLOY_TOKEN }}"
```

---

## 安全考虑

### 1. 环境变量管理

```bash
# .env.local (本地开发)
NEXT_PUBLIC_SUPABASE_URL=          # 公开
NEXT_PUBLIC_SUPABASE_ANON_KEY=     # 公开 (Anon Key)
FMP_API_KEY=                       # 私密
DEEPSEEK_API_KEY=                  # 私密
STRIPE_SECRET_KEY=                 # 私密 (后续添加)

# GitHub Secrets (CI/CD)
SUPABASE_URL
SUPABASE_KEY                       # Service Role Key
FMP_API_KEY
DEEPSEEK_API_KEY
VERCEL_PROJECT_ID
VERCEL_DEPLOY_TOKEN
```

### 2. 数据库安全

- 使用 Row Level Security (RLS)
- 只暴露必要的列
- 敏感操作使用 Service Role Key

```sql
-- 启用 RLS
ALTER TABLE earnings ENABLE ROW LEVEL SECURITY;

-- 允许匿名读取已发布的财报
CREATE POLICY "Allow anonymous read published earnings"
ON earnings FOR SELECT
USING (is_published = TRUE);

-- 只允许认证用户访问草稿
CREATE POLICY "Allow authenticated read all earnings"
ON earnings FOR SELECT
TO authenticated
USING (TRUE);
```

### 3. API 安全

- 使用 Next.js API Routes 作为代理
- 敏感 API 密钥不暴露给前端
- 实现速率限制

---

## 性能优化

### 1. 数据获取

```typescript
// 使用 Next.js 内置的数据缓存
export const revalidate = 300 // 5分钟重新验证

// 使用 React Server Components
export default async function EarningsPage() {
  // 数据在服务端获取，不发送到客户端
  const earnings = await getEarnings()
  return <EarningsList data={earnings} />
}
```

### 2. 图片优化

```typescript
import Image from 'next/image'

// 使用 Next.js Image 组件自动优化
<Image
  src="/company-logo.png"
  width={64}
  height={64}
  alt="Company Logo"
  loading="lazy"
/>
```

### 3. 字体优化

```typescript
// 使用 next/font 自动优化
import { Inter } from 'next/font/google'

const inter = Inter({ 
  subsets: ['latin'],
  display: 'swap',
})
```

---

## 监控与日志

### Vercel Analytics

- Web Analytics (页面性能)
- Speed Insights (Core Web Vitals)

### 自定义日志

```typescript
// lib/logger.ts
export const logger = {
  info: (message: string, meta?: Record<string, any>) => {
    console.log(JSON.stringify({ level: 'info', message, ...meta, timestamp: new Date().toISOString() }))
  },
  error: (message: string, error: Error, meta?: Record<string, any>) => {
    console.error(JSON.stringify({ 
      level: 'error', 
      message, 
      error: error.message,
      stack: error.stack,
      ...meta, 
      timestamp: new Date().toISOString() 
    }))
  }
}
```

---

## 扩展规划

### Phase 1: MVP (Month 1)
- 前端页面开发
- 基础数据库
- 手动数据填充

### Phase 2: 自动化 (Month 2)
- AI 分析集成
- 自动化数据获取
- GitHub Actions

### Phase 3: 规模化 (Month 3)
- 扩展到 30 家公司
- 财报日历
- 邮件订阅

### Phase 4: 增长 (Month 4+)
- SEO 优化
- 性能优化
- 高级功能

---

**相关文档**:
- [项目总览](./00-项目总览.md)
- [计划1: MVP启动](./计划1-MVP启动.md)
- [Design Token 详情](../pencil-earnlytics.pen)
