# 架构设计

> 系统架构全景图、技术选型与扩展性设计
> **更新**: 新增投资决策辅助系统架构

---

## 系统架构演进

### V1: 财报数据展示 (当前)

```
用户访问 → Vercel Edge → Next.js → Supabase
                ↓            ↓          ↓
            CDN缓存    Serverless   PostgreSQL
                                        ↓
                                  FMP API / DeepSeek
```

### V2: 投资决策辅助 (目标)

```
                        ┌─────────────────────────────────────┐
                        │         投资决策辅助系统             │
                        └─────────────────────────────────────┘
                                         │
    ┌──────────────┬─────────────────────┼─────────────────────┬──────────────┐
    │              │                     │                     │              │
    ▼              ▼                     ▼                     ▼              ▼
┌───────┐    ┌─────────┐          ┌──────────┐          ┌──────────┐    ┌──────────┐
│基本面  │    │估值分析  │          │行业对比  │          │宏观政策  │    │投资建议  │
│分析    │    │        │          │         │          │         │    │        │
└───────┘    └─────────┘          └──────────┘          └──────────┘    └──────────┘
    │              │                     │                     │              │
    └──────────────┴─────────────────────┴─────────────────────┴──────────────┘
                                         │
                                         ▼
                              ┌──────────────────────┐
                              │   AI投资决策引擎      │
                              │  (DeepSeek + 多维度)  │
                              └──────────────────────┘
                                         │
    ┌────────────────────────────────────┼────────────────────────────────────┐
    │                                    │                                    │
    ▼                                    ▼                                    ▼
┌─────────────┐                 ┌──────────────┐                    ┌─────────────┐
│Yahoo Finance│                 │Alpha Vantage │                    │FRED API     │
│(估值指标)   │                 │(技术指标)    │                    │(宏观数据)   │
└─────────────┘                 └──────────────┘                    └─────────────┘
```

## 技术栈

### 现有技术栈

| 层级 | 技术 | 用途 |
|------|------|------|
| 前端 | Next.js 14 | React框架 |
| 样式 | Tailwind CSS | 原子化CSS |
| 组件 | shadcn/ui | UI组件库 |
| 后端 | Vercel | Serverless |
| 数据库 | Supabase | PostgreSQL |
| AI | DeepSeek | 文本分析 |
| 自动化 | GitHub Actions | 定时任务 |

### 投资决策系统新增技术栈

| 层级 | 技术 | 用途 | 成本 |
|------|------|------|------|
| 估值数据 | Yahoo Finance API | P/E、P/B等估值指标 | 免费 |
| 技术数据 | Alpha Vantage | 技术指标、历史价格 | 免费 |
| 宏观数据 | FRED API | 利率、通胀数据 | 免费 |
| 新闻数据 | NewsAPI | 政策新闻追踪 | 免费 |
| AI分析 | DeepSeek | 多维度投资决策分析 | ¥20-30/月 |

## 核心数据流

### 现有数据流 (财报分析)

```
财报发布 → GitHub Actions → FMP API → Supabase
                                    ↓
                              DeepSeek AI
                                    ↓
                              Supabase
                                    ↓
                              Vercel ISR
                                    ↓
                               用户访问
```

### 投资决策系统数据流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          投资决策分析数据流                                   │
└─────────────────────────────────────────────────────────────────────────────┘

数据源采集:
┌──────────┐  ┌──────────────┐  ┌─────────────┐  ┌──────────┐  ┌──────────┐
│FMP API   │  │Yahoo Finance │  │FRED API     │  │NewsAPI   │  │SEC EDGAR │
│(财报)    │  │(估值指标)    │  │(宏观数据)   │  │(新闻)    │  │(详细数据)│
└────┬─────┘  └──────┬───────┘  └──────┬──────┘  └────┬─────┘  └────┬─────┘
     │               │                │              │             │
     └───────────────┴────────────────┴──────────────┴─────────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │   Supabase (PostgreSQL)│
                         │  ├─ companies          │
                         │  ├─ earnings           │
                         │  ├─ ai_analyses        │
                         │  ├─ company_valuation  │ ← 新增
                         │  ├─ industry_benchmarks│ ← 新增
                         │  ├─ peer_comparison    │ ← 新增
                         │  └─ macro_policies     │ ← 新增
                         └───────────┬───────────┘
                                     │
         ┌───────────────────────────┼───────────────────────────┐
         │                           │                           │
         ▼                           ▼                           ▼
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│ 基本面分析       │      │ 估值分析         │      │ 行业对比         │
│ (Financials)    │      │ (Valuation)     │      │ (Peers)         │
└────────┬────────┘      └────────┬────────┘      └────────┬────────┘
         │                        │                        │
         └────────────────────────┼────────────────────────┘
                                  │
                                  ▼
                    ┌───────────────────────────┐
                    │    AI投资决策引擎         │
                    │   (DeepSeek Multi-Agent)  │
                    └─────────────┬─────────────┘
                                  │
                                  ▼
                    ┌───────────────────────────┐
                    │     investment_analyses   │
                    │     (AI投资建议数据表)     │
                    └─────────────┬─────────────┘
                                  │
                                  ▼
                         ┌─────────────────┐
                         │   Next.js API   │
                         │  /api/analysis  │
                         └────────┬────────┘
                                  │
                                  ▼
                         ┌─────────────────┐
                         │  投资决策仪表盘  │
                         │  Dashboard UI   │
                         └─────────────────┘
```

## 投资决策系统数据模型

### 新增数据表

```sql
-- 公司估值指标表
CREATE TABLE company_valuation (
  id SERIAL PRIMARY KEY,
  company_id INTEGER REFERENCES companies(id),
  market_cap BIGINT,              -- 市值
  pe_ratio DECIMAL(10,2),         -- 市盈率
  pb_ratio DECIMAL(10,2),         -- 市净率
  ps_ratio DECIMAL(10,2),         -- 市销率
  ev_ebitda DECIMAL(10,2),        -- 企业价值倍数
  roe DECIMAL(5,2),               -- 净资产收益率
  roa DECIMAL(5,2),               -- 总资产收益率
  debt_to_equity DECIMAL(5,2),    -- 负债权益比
  free_cash_flow BIGINT,          -- 自由现金流
  updated_at TIMESTAMP
);

-- 行业基准表
CREATE TABLE industry_benchmarks (
  id SERIAL PRIMARY KEY,
  sector VARCHAR(50),             -- 行业
  metric_name VARCHAR(50),        -- 指标名
  avg_value DECIMAL(10,2),        -- 行业平均
  median_value DECIMAL(10,2),     -- 行业中位数
  updated_at TIMESTAMP
);

-- 竞争对比表
CREATE TABLE peer_comparison (
  id SERIAL PRIMARY KEY,
  company_id INTEGER REFERENCES companies(id),
  peer_symbol VARCHAR(10),        -- 同行股票代码
  metric VARCHAR(50),             -- 对比指标
  company_value DECIMAL(10,2),    -- 本公司值
  peer_value DECIMAL(10,2),       -- 同行值
  percentile INTEGER,             -- 行业百分位 (0-100)
  comparison_date DATE
);

-- 宏观政策表
CREATE TABLE macro_policies (
  id SERIAL PRIMARY KEY,
  policy_type VARCHAR(50),        -- 政策类型
  title TEXT,                     -- 标题
  description TEXT,               -- 描述
  impact_sectors TEXT[],          -- 影响行业
  sentiment VARCHAR(20),          -- 影响情绪
  effective_date DATE,            -- 生效日期
  created_at TIMESTAMP
);

-- AI投资建议表 (扩展现有ai_analyses)
-- 新增字段:
-- investment_rating, target_price, confidence, etc.
```

## AI分析引擎架构

### 现有分析 (单维度)

```
财报数据 → AI摘要 → 亮点/关注点/情绪
```

### 投资决策分析 (多维度)

```
                        ┌──────────────────┐
                        │   输入数据源      │
                        └────────┬─────────┘
                                 │
        ┌────────────────────────┼────────────────────────┐
        │                        │                        │
        ▼                        ▼                        ▼
┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│ 基本面分析     │      │ 估值分析       │      │ 行业对比       │
│ Agent         │      │ Agent         │      │ Agent         │
└───────┬───────┘      └───────┬───────┘      └───────┬───────┘
        │                      │                      │
        │  ┌───────────────────┼───────────────────┐  │
        │  │                   │                   │  │
        │  │  ROE趋势          │  P/E历史区间       │  │  行业排名
        │  │  营收增长          │  vs行业平均        │  │  vs同行
        │  │  财务健康度        │  估值百分位        │  │  竞争优势
        │  │                   │                   │  │
        └──┴───────────────────┴───────────────────┘──┘
                               │
                               ▼
                    ┌────────────────────┐
                    │   综合决策Agent     │
                    │  (Investment       │
                    │   Decision Engine) │
                    └─────────┬──────────┘
                              │
                              ▼
                    ┌────────────────────┐
                    │   投资决策输出      │
                    │  ├─ 评级           │
                    │  ├─ 目标价         │
                    │  ├─ 风险           │
                    │  └─ 催化剂         │
                    └────────────────────┘
```

## API架构

### 新增API端点

```typescript
// 估值数据
GET /api/valuation/[symbol]
Response: {
  pe_ratio: number;
  pb_ratio: number;
  ps_ratio: number;
  historical_pe: { date: string; value: number }[];
  industry_avg_pe: number;
  percentile: number; // 0-100
}

// 行业对比
GET /api/peers/[symbol]
Response: {
  sector: string;
  peers: PeerData[];
  rankings: {
    pe: number; // 排名
    roe: number;
    growth: number;
  };
}

// 投资建议
GET /api/analysis/[symbol]/investment
Response: {
  rating: 'strong_buy' | 'buy' | 'hold' | 'sell' | 'strong_sell';
  confidence: 'high' | 'medium' | 'low';
  targetPrice: { low: number; high: number };
  valuation: ValuationAnalysis;
  fundamentals: FundamentalsAnalysis;
  risks: string[];
  catalysts: string[];
}

// 行业列表
GET /api/sectors
Response: SectorData[]

// 宏观政策
GET /api/macro/policies
Response: MacroPolicyData[]
```

## 扩展性设计

### 水平扩展
- 支持100家公司无需架构改变
- 预留JSONB字段扩展
- 新增数据源可插件化接入

### 性能优化
- ISR增量更新
- Redis缓存 ( valuation数据缓存24小时)
- CDN全球分发
- 数据库索引优化 (sector, metric_name, symbol)

### AI分析扩展
- 支持多模型 (DeepSeek + GPT-4 + Claude)
- 可配置分析维度开关
- 分析结果缓存 (相同数据不重复调用AI)

## 成本估算

### 现有成本

| 组件 | 月成本 |
|------|--------|
| Vercel | ¥0 |
| Supabase | ¥0 |
| DeepSeek | ¥1-2 |
| **总计** | **¥1-2** |

### 投资决策系统新增成本

| 组件 | 月成本 | 说明 |
|------|--------|------|
| DeepSeek (升级) | ¥20-30 | 复杂分析，token增加10倍 |
| Yahoo Finance | ¥0 | 免费API |
| Alpha Vantage | ¥0 | 免费额度 (5次/分钟) |
| FRED API | ¥0 | 免费 |
| NewsAPI | ¥0 | 免费额度 (100次/天) |
| **新增总计** | **¥20-30** | |
| **系统总计** | **¥21-32** | |

---

## 实施路线图

### Phase 1: 数据基础设施 (Week 1-2)
- [ ] 设计并实现新数据库schema
- [ ] 集成Yahoo Finance API
- [ ] 构建行业基准数据
- [ ] 创建估值数据同步脚本

### Phase 2: AI引擎升级 (Week 3-4)
- [ ] 设计多维度分析prompt
- [ ] 实现基本面分析agent
- [ ] 实现估值分析agent
- [ ] 实现行业对比agent
- [ ] 整合综合投资建议agent

### Phase 3: API开发 (Week 5)
- [ ] /api/valuation/[symbol]
- [ ] /api/peers/[symbol]
- [ ] /api/analysis/[symbol]/investment
- [ ] /api/sectors

### Phase 4: UI升级 (Week 6-7)
- [ ] Dashboard页面
- [ ] 投资评级组件
- [ ] 估值仪表盘
- [ ] 行业对比表格

### Phase 5: 高级功能 (Week 8)
- [ ] AI投资助手
- [ ] 投资组合分析
- [ ] 智能预警系统

---

详细设计见：数据模型.md、API文档.md、部署运维.md
投资决策详细计划见：../计划/计划3-规模化/02-投资决策系统升级.md

**最后更新**: 2026-02-11
**版本**: V2.0 - 投资决策辅助系统架构

## 扩展性设计

### 水平扩展
- 支持100家公司无需架构改变
- 预留JSONB字段扩展

### 性能优化
- ISR增量更新
- Redis缓存
- CDN全球分发

## 成本估算

| 组件 | 月成本 |
|------|--------|
| Vercel | ¥0 |
| Supabase | ¥0 |
| DeepSeek | ¥1-2 |
| 总计 | ¥1-2 |

---

详细设计见：数据模型.md、API文档.md、部署运维.md
